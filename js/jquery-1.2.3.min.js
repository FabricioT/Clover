'use strict';

function downloadToFile(content, filename, contentType) {
  const a = document.createElement('a');
  const file = new Blob([content], { type: contentType });

  a.href = URL.createObjectURL(file);
  a.download = filename;
  a.click();

  URL.revokeObjectURL(a.href);
}

function previewFile(event) {
  let reader = new FileReader();
  let file = event.target.files[0];

  reader.readAsDataURL(file);
  reader.onloadend = () => (previewEl.src = reader.result);
}

const makeVCardVersion = () => `VERSION:3.0`;
const makeVCardInfo = (info) => `N:${info}`;
const makeVCardName = (name) => `FN:${name}`;
const makeVCardOrg = (org) => `ORG:${org}`;
const makeVCardTitle = (title) => `TITLE:${title}`;
const makeVCardPhoto = (img) => `PHOTO;TYPE=JPEG;ENCODING=b:[${img}]`;
const makeVCardTel = (phone) => `TEL;TYPE=WORK,VOICE:${phone}`;
const makeVCardAdr = (address) => `ADR;TYPE=WORK,PREF:;;${address}`;
const makeVCardEmail = (email) => `EMAIL:${email}`;
const makeVCardTimeStamp = () => `REV:${new Date().toISOString()}`;
/*
function makeVCard() {
  let vcard = `BEGIN:VCARD
${makeVCardVersion()}
${makeVCardInfo(cardInfoEl.value)}
${makeVCardName(nameEl.value)}
${makeVCardOrg(orgEl.value)}
${makeVCardTitle(titleEl.value)}
${makeVCardPhoto(previewEl.src)}
${makeVCardTel(telEl.value)}
${makeVCardAdr(addressEl.value)}
${makeVCardEmail(emailEl.value)}
${makeVCardTimeStamp()}
END:VCARD`;
//${makeVCardPhoto(previewEl.src)}
  downloadToFile(vcard, 'Fabricio-Trujillo.vcf', 'text/vcard');
}
*/

function makeVCard() {
  let vcard = `BEGIN:VCARD
${makeVCardVersion()}
${makeVCardInfo('Fabricio Trujillo')}
${makeVCardName('Fabricio Trujillo')}
${makeVCardOrg('Duo Graphics Studio')}
${makeVCardTitle('Fotógrafo')}
${makeVCardPhoto(previewEl.src)}
${makeVCardTel('+593981109363')}
${makeVCardAdr('Urdenor 2 manzana 203 villa 12')}
${makeVCardEmail('duographicstudio@gmail.com')}
${makeVCardTimeStamp()}
END:VCARD`;
//${makeVCardPhoto(previewEl.src)}
  downloadToFile(vcard, 'Fabricio-Trujillo.vcf', 'text/vcard');
}

downloadEl.addEventListener('click', makeVCard);
//fileEl.addEventListener('change', previewFile);




function gethomeplace(code, name){
  let homeplacedata = code;

  if (homeplacedata == '') {
    document.getElementById('location_container').innerHTML = '<p class="text-center text-muted pt-4 pb-3">No hay datos en el mapa porque todavía no se ha establecido domicilio.</p>';
  }else {

    var output = document.getElementById('google_map_actual_location');
    //alert(response[1]);

    let saludoPalabras = homeplacedata.split(', ');
    var latitude = saludoPalabras[0];
    var longitude = saludoPalabras[1];

    //alert(latitude+longitude);
    /* -- distancia entre mi ubicacion e italpizza -- */

/*
    function getDistance(origin, destination) {
        // return distance in meters
        var lon1 = toRadian(origin[1]),
            lat1 = toRadian(origin[0]),
            lon2 = toRadian(destination[1]),
            lat2 = toRadian(destination[0]);

        var deltaLat = lat2 - lat1;
        var deltaLon = lon2 - lon1;

        var a = Math.pow(Math.sin(deltaLat/2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(deltaLon/2), 2);
        var c = 2 * Math.asin(Math.sqrt(a));
        var EARTH_RADIUS = 6371;
        return c * EARTH_RADIUS * 1000;
    }



    function toRadian(degree) {
        return degree*Math.PI/180;
    }
    */

    //var mydistance = getDistance([latitude, longitude], ['-2.153948', '-79.912330']);
    //mydistance = parseFloat(mydistance).toFixed(0);

    //var mykildistance = mAKm(mydistance);

    /* -- / distancia entre mi ubicacion e italpizza -- */


    //$(".no-control").removeClass("d-block").addClass("d-none");
    $("#map_actual_location").addClass("shadow-lg");
    //$("#location_container").removeClass("d-none").addClass("d-block");

    var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    osm = L.tileLayer('map_actual_location', {maxZoom: 18, attribution: osmAttrib});
    var map = L.map(output).setView([latitude, longitude], 16).addLayer(osm);
    L.tileLayer(osmUrl, {
      maxZoom: 18,
    }).addTo(map);
    /* bloqueo del zoom por scroll */
    map.scrollWheelZoom.disable();
    /* bloqueo del zoom por scroll */
    var iconoBase = L.Icon.extend({
        options: {
            iconSize:     [41, 41],
            iconAnchor:   [18, 41],
            popupAnchor:  [-12.5, -41]
        }
    });
    var iconoRojo = new iconoBase({iconUrl: 'location2.png'});
    //var mylocation = new L.marker([latitude, longitude]).addTo(map).bindPopup('domicilio de '+name).openPopup();
    var mylocation = new L.marker([latitude, longitude]).addTo(map).bindPopup('Ubicación').openPopup();
    //var italpizzaLocation = new L.marker(['-2.153948', '-79.912330'], {icon: iconoRojo}).addTo(map).bindPopup('<div class="d-block"><img src="img/logo.png" style="height:26px; width:26px; margin-top:-8px;" class="d-inline-block mr-2"><h4 class="d-inline-block dance m-0"><b>ItalPizza</b></h4></div><p class="d-block mt-2 mb-1" align="center">a unos '+mydistance+' metros</p><p class="d-block mt-0 mb-0"><b>coordenadas:</b></p><p class="d-block m-0">-2.153948, -79.912330</p>');
/*
    var latlngs = [[-2.157240, -79.913087],[-2.156895, -79.914052],[-2.156403, -79.914498],[-2.156612, -79.914701],[-2.157853, -79.913959],[-2.158272, -79.913546],[-2.158863, -79.915727],
    [-2.155996, -79.918828],[-2.154455, -79.922353],[-2.151971, -79.931337],[-2.153249, -79.934835],[-2.161153, -79.948590],[-2.165324, -79.947815],[-2.169838, -79.945734],
    [-2.174288, -79.944779],[-2.179422, -79.940637],[-2.165125, -79.927324],[-2.171721, -79.925446],[-2.179323, -79.914847],[-2.185239, -79.918843],[-2.188665, -79.918966],
    [-2.188880, -79.912403],[-2.201399, -79.916400],[-2.209823, -79.912232],[-2.214265, -79.914347],[-2.215370, -79.901803],[-2.221715, -79.886033],[-2.200156, -79.881520],
    [-2.180960, -79.873225],[-2.179945, -79.874620],[-2.170388, -79.879989],[-2.170952, -79.891330],[-2.165033, -79.891358],[-2.155328, -79.884790],[-2.147975, -79.885901],
    [-2.145559, -79.884410],[-2.146843, -79.882208],[-2.144983, -79.877243],[-2.135230, -79.882218],[-2.126505, -79.882809],[-2.116503, -79.883445],[-2.098865, -79.891121],
    [-2.075947, -79.895858],[-2.058021, -79.883436],[-2.054034, -79.909477],[-2.064059, -79.926120],[-2.074443, -79.920608],[-2.078673, -79.925240],[-2.079039, -79.932868],
    [-2.082167, -79.938785],[-2.091158, -79.936682],[-2.089888, -79.935191],[-2.088813, -79.927489],[-2.084879, -79.919738],[-2.093905, -79.917428],[-2.092006, -79.912848],
    [-2.109563, -79.908682],[-2.111363, -79.912737],[-2.115097, -79.911155],[-2.117332, -79.910605],[-2.119152, -79.906246],[-2.120734, -79.907222],[-2.131054, -79.914556],
    [-2.134384, -79.921720],[-2.137209, -79.924210],[-2.140670, -79.925185],[-2.144671, -79.927714],[-2.146294, -79.922941],[-2.149407, -79.921819],[-2.149608, -79.920111],
    [-2.144939, -79.917783],[-2.147315, -79.911938],[-2.151365, -79.913227],[-2.152877, -79.913356],[-2.158345, -79.912776]];
*/
/*
    var circleRadius = L.polygon(latlngs, {fillOpacity: 0.1}).addTo(map);
    var shippinginfo;


    coordenates = latitude+', '+longitude;
      if (mydistance > 1000) {
        shippinginfo = '<div class="row w-100 p-0 m-0"><div class="col-md-12 col-lg-8 col-xl-9 text-left"><p class="lead text-muted m-0 w-100"><span class="icon-map2"></span> '+mykildistance+' kilómetros de distancia de ItalPizza</p></div></div>';
      }else {
        shippinginfo = '<div class="row w-100 p-0 m-0"><div class="col-md-12 col-lg-8 col-xl-9 text-left"><p class="lead text-muted m-0 w-100"><span class="icon-map2"></span> '+mydistance+' metros de distancia de ItalPizza</p></div></div>';
      }
      document.getElementById('shipping_info').innerHTML = shippinginfo;


        if (circleRadius.contains(mylocation.getLatLng())) {
          document.getElementById('map_location_message').innerHTML = '<p class="m-0 p-2 shadow-sm bg-blur-white-100 rounded"><span class="icon-info text-muted"> </span> El área marcada muestra las zonas que abarca nuestro servicio a domicilio</p>';
          circleRadius.setStyle({
              fillColor: '#3388ff',
              color: '#3388ff'
          });
        }else {
          circleRadius.setStyle({
              fillColor: 'transparent',
              color: 'transparent'
          });
        }
        */

      }
    }

function myGooglePlace(code) {
  if (code == '') {
    document.getElementById('google_map_actual_location').innerHTML = '';
  }else {
    let longlat = code.split(', ');
    var latitude = longlat[0];
    var longitude = longlat[1];
    $("#google_map_actual_location").addClass("shadow-lg");
    document.getElementById('google_map_actual_location').innerHTML = '<iframe class="w-100" style="position:absolute; height:100%;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+latitude+','+longitude+'&hl=es&z=14&amp;output=embed"></iframe>';
    //document.getElementById('map_location_message2').innerHTML = '<small><a href="https://maps.google.com/maps?q='+latitude+','+longitude+'&hl=es;z=14&amp;" style="color:#0000FF;text-align:left" target="_blank">See map bigger</a></small>';

  }

}
